<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeatherVista | Beautiful Weather App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: background 1.5s ease;
            position: relative;
            overflow-x: hidden;
        }

        /* Weather Animation Elements */
        .weather-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        /* Canvas for weather animations */
        #weather-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Theme toggle */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .container {
            width: 100%;
            max-width: 450px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            z-index: 1;
            transition: all 0.3s ease;
        }

        body.dark-mode .container {
            background: rgba(0, 0, 0, 0.2);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .app-title {
            font-size: 20px;
            font-weight: 600;
        }

        .unit-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .unit-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .search-box {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
            height: 45px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            outline: none;
            border-radius: 30px;
            padding: 0 20px;
            color: #fff;
            font-size: 16px;
            margin-right: 15px;
        }

        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-box button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: #fff;
            color: #6a11cb;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-box button:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }

        .weather-info {
            text-align: center;
            margin-top: 15px;
        }

        .city-name {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .date {
            font-size: 14px;
            font-weight: 300;
            margin-bottom: 20px;
        }

        .temperature {
            font-size: 70px;
            font-weight: 700;
            margin: 5px 0;
            position: relative;
            display: inline-block;
        }

        .temperature::after {
            content: "°C";
            position: absolute;
            top: 15px;
            right: -30px;
            font-size: 20px;
        }

        .temperature.fahrenheit::after {
            content: "°F";
        }

        .weather-description {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin: 10px 0;
        }

        .weather-icon {
            font-size: 28px;
            margin-right: 8px;
        }

        .details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        body.dark-mode .detail-item {
            background: rgba(0, 0, 0, 0.2);
        }

        .detail-item i {
            font-size: 20px;
            margin-bottom: 8px;
        }

        .detail-label {
            font-size: 12px;
            font-weight: 300;
            margin-bottom: 3px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
        }

        .forecast-container {
            margin-top: 20px;
        }

        .forecast-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .forecast-toggle {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 13px;
            opacity: 0.8;
        }

        .hourly-forecast {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            scrollbar-width: thin;
            margin-bottom: 15px;
        }

        .hourly-forecast::-webkit-scrollbar {
            height: 5px;
        }

        .hourly-forecast::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .hourly-item {
            flex: 0 0 auto;
            text-align: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-right: 8px;
            min-width: 80px;
        }

        body.dark-mode .hourly-item {
            background: rgba(0, 0, 0, 0.2);
        }

        .hourly-time {
            font-size: 12px;
            font-weight: 500;
        }

        .hourly-icon {
            font-size: 18px;
            margin: 5px 0;
        }

        .hourly-temp {
            font-size: 14px;
            font-weight: 600;
        }

        .daily-forecast {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .daily-item {
            text-align: center;
            padding: 8px 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        body.dark-mode .daily-item {
            background: rgba(0, 0, 0, 0.2);
        }

        .daily-day {
            font-size: 12px;
            font-weight: 500;
        }

        .daily-icon {
            font-size: 18px;
            margin: 5px 0;
        }

        .daily-temp {
            font-size: 14px;
            font-weight: 600;
        }

        .weather-alert {
            background: rgba(255, 77, 77, 0.3);
            border-left: 4px solid #ff4d4d;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            animation: pulseAlert 2s infinite;
        }

        @keyframes pulseAlert {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        .alert-icon {
            margin-right: 8px;
            color: #ff4d4d;
        }

        .loading {
            text-align: center;
            padding: 30px 0;
            display: none;
        }

        .loading i {
            font-size: 35px;
            animation: spin 1.5s linear infinite;
        }

        /* Skeleton loading */
        .skeleton {
            animation: skeleton-loading 1s linear infinite alternate;
            border-radius: 8px;
            opacity: 0.7;
        }

        @keyframes skeleton-loading {
            0% { background-color: rgba(255, 255, 255, 0.1); }
            100% { background-color: rgba(255, 255, 255, 0.2); }
        }

        .skeleton-text {
            width: 100%;
            height: 12px;
            margin-bottom: 8px;
        }

        .skeleton-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            text-align: center;
            padding: 15px;
            background: rgba(255, 99, 99, 0.2);
            border-radius: 12px;
            margin-top: 15px;
            display: none;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        body.dark-mode .action-btn {
            background: rgba(0, 0, 0, 0.2);
        }

        .action-btn i {
            margin-right: 5px;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .action-btn:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .api-status {
            text-align: center;
            margin-top: 12px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .temperature {
                font-size: 60px;
            }
            
            .details {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .daily-forecast {
                grid-template-columns: repeat(3, 1fr);
            }

            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }
            
            .city-name {
                font-size: 24px;
            }
            
            .weather-description {
                font-size: 16px;
            }
            
            .weather-icon {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
        <i class="fas fa-moon"></i>
    </button>
    
    <div class="weather-background" id="weather-background">
        <canvas id="weather-canvas"></canvas>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="app-title">WeatherVista</div>
            <button class="unit-toggle" id="unit-toggle">°C / °F</button>
        </div>

        <div class="search-box">
            <input type="text" placeholder="Search for a city..." id="search-input" aria-label="Search for a city">
            <button id="search-btn" aria-label="Search"><i class="fas fa-search"></i></button>
        </div>

        <div class="weather-info">
            <h1 class="city-name" id="city-name">New York</h1>
            <p class="date" id="date">Monday, October 10</p>
            <h2 class="temperature" id="temperature" aria-live="polite">24</h2>
            <div class="weather-description">
                <i class="fas fa-cloud-sun weather-icon" id="weather-icon"></i>
                <span id="weather-description" aria-live="polite">Partly Cloudy</span>
            </div>
        </div>

        <div class="details">
            <div class="detail-item">
                <i class="fas fa-wind"></i>
                <div class="detail-label">Wind Speed</div>
                <div class="detail-value" id="wind-speed">5 km/h</div>
            </div>
            <div class="detail-item">
                <i class="fas fa-tint"></i>
                <div class="detail-label">Humidity</div>
                <div class="detail-value" id="humidity">65%</div>
            </div>
            <div class="detail-item">
                <i class="fas fa-compress-arrows-alt"></i>
                <div class="detail-label">Pressure</div>
                <div class="detail-value" id="pressure">1015 hPa</div>
            </div>
            <div class="detail-item">
                <i class="fas fa-eye"></i>
                <div class="detail-label">Visibility</div>
                <div class="detail-value" id="visibility">10 km</div>
            </div>
        </div>

        <div class="weather-alert" id="weather-alert">
            <i class="fas fa-exclamation-triangle alert-icon"></i>
            <span id="alert-message">Thunderstorm expected tonight ⚡</span>
        </div>

        <div class="forecast-container">
            <div class="forecast-title">
                <span>Hourly Forecast</span>
                <button class="forecast-toggle" id="forecast-toggle">5-day forecast <i class="fas fa-chevron-down"></i></button>
            </div>
            
            <div class="hourly-forecast" id="hourly-forecast">
                <!-- Hourly forecast will be populated by JavaScript -->
            </div>
            
            <div class="daily-forecast" id="daily-forecast" style="display: none;">
                <!-- Daily forecast will be populated by JavaScript -->
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn" id="location-btn">
                <i class="fas fa-location-arrow"></i> My Location
            </button>
            <button class="action-btn" id="refresh-btn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>

        <div class="api-status">
            <i class="fas fa-check-circle"></i> API Key: Pre-configured
        </div>

        <div class="loading" id="loading">
            <i class="fas fa-spinner"></i>
        </div>

        <div class="error" id="error">
            <p>City not found. Please try again.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const searchBtn = document.getElementById('search-btn');
            const searchInput = document.getElementById('search-input');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const weatherCanvas = document.getElementById('weather-canvas');
            const unitToggle = document.getElementById('unit-toggle');
            const locationBtn = document.getElementById('location-btn');
            const refreshBtn = document.getElementById('refresh-btn');
            const temperatureElement = document.getElementById('temperature');
            const themeToggle = document.getElementById('theme-toggle');
            const weatherAlert = document.getElementById('weather-alert');
            const forecastToggle = document.getElementById('forecast-toggle');
            const hourlyForecast = document.getElementById('hourly-forecast');
            const dailyForecast = document.getElementById('daily-forecast');
            
            // Canvas context
            const ctx = weatherCanvas.getContext('2d');
            
            // State management
            let currentWeatherData = null;
            let isCelsius = true;
            let currentCity = 'New York';
            let isDarkMode = false;
            let isShowingDailyForecast = false;
            let animationId = null;
            
            // Your OpenWeatherMap API Key (pre-configured)
            const apiKey = '4ba427d674f35e6e37b60b16ed687b27';
            
            // Weather condition to background mapping
            const weatherBackgrounds = {
                'sunny': 'linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%)',
                'partly-cloudy': 'linear-gradient(135deg, #4da0ff 0%, #d39dff 100%)',
                'cloudy': 'linear-gradient(135deg, #616161 0%, #9bc5c3 100%)',
                'rainy': 'linear-gradient(135deg, #005C97 0%, #363795 100%)',
                'stormy': 'linear-gradient(135deg, #0F2027 0%, #203A43 50%, #2C5364 100%)',
                'snowy': 'linear-gradient(135deg, #8e9eab 0%, #eef2f3 100%)',
                'night': 'linear-gradient(135deg, #0c3483 0%, #a2b6df 100%, #6b8cce 100%, #a2b6df 100%)'
            };
            
            // Weather icon mapping
            const weatherIcons = {
                '01d': 'fa-sun',
                '01n': 'fa-moon',
                '02d': 'fa-cloud-sun',
                '02n': 'fa-cloud-moon',
                '03d': 'fa-cloud',
                '03n': 'fa-cloud',
                '04d': 'fa-cloud',
                '04n': 'fa-cloud',
                '09d': 'fa-cloud-showers-heavy',
                '09n': 'fa-cloud-showers-heavy',
                '10d': 'fa-cloud-sun-rain',
                '10n': 'fa-cloud-moon-rain',
                '11d': 'fa-bolt',
                '11n': 'fa-bolt',
                '13d': 'fa-snowflake',
                '13n': 'fa-snowflake',
                '50d': 'fa-smog',
                '50n': 'fa-smog'
            };
            
            // Set canvas size
            function resizeCanvas() {
                weatherCanvas.width = window.innerWidth;
                weatherCanvas.height = window.innerHeight;
            }
            
            // Update date
            function updateDate() {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('date').textContent = now.toLocaleDateString('en-US', options);
            }
            
            // Clear all weather animations
            function clearWeatherAnimations() {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                
                ctx.clearRect(0, 0, weatherCanvas.width, weatherCanvas.height);
            }
            
            // Change background based on weather condition
            function updateWeatherBackground(condition, iconCode) {
                const body = document.body;
                
                // Clear previous animations
                clearWeatherAnimations();
                
                // Set background based on condition
                const normalizedCondition = condition.toLowerCase();
                let bgValue = weatherBackgrounds['sunny']; // default
                
                if (normalizedCondition.includes('clear') && iconCode.includes('n')) {
                    bgValue = weatherBackgrounds['night'];
                    createStarsAnimation();
                } else if (normalizedCondition.includes('clear')) {
                    bgValue = weatherBackgrounds['sunny'];
                    createSunAnimation();
                } else if (normalizedCondition.includes('cloud')) {
                    bgValue = weatherBackgrounds['cloudy'];
                    createCloudAnimation();
                } else if (normalizedCondition.includes('rain') || normalizedCondition.includes('drizzle')) {
                    bgValue = weatherBackgrounds['rainy'];
                    createRainAnimation();
                } else if (normalizedCondition.includes('thunder')) {
                    bgValue = weatherBackgrounds['stormy'];
                    createRainAnimation(true);
                } else if (normalizedCondition.includes('snow')) {
                    bgValue = weatherBackgrounds['snowy'];
                    createSnowAnimation();
                } else {
                    // Check if it's night time based on icon code
                    if (iconCode.includes('n')) {
                        bgValue = weatherBackgrounds['night'];
                        createStarsAnimation();
                    } else {
                        bgValue = weatherBackgrounds['sunny'];
                        createSunAnimation();
                    }
                }
                
                // Smooth background transition
                body.style.transition = 'background 1.5s ease';
                body.style.background = bgValue;
            }
            
            // Create cloud animation using canvas
            function createCloudAnimation() {
                const clouds = [];
                
                for (let i = 0; i < 5; i++) {
                    clouds.push({
                        x: Math.random() * weatherCanvas.width,
                        y: Math.random() * weatherCanvas.height * 0.6,
                        radius: Math.random() * 40 + 20,
                        speed: Math.random() * 0.5 + 0.2
                    });
                }
                
                function draw() {
                    ctx.clearRect(0, 0, weatherCanvas.width, weatherCanvas.height);
                    
                    clouds.forEach(cloud => {
                        ctx.beginPath();
                        ctx.arc(cloud.x, cloud.y, cloud.radius, 0, Math.PI * 2);
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                        ctx.fill();
                        
                        // Move cloud
                        cloud.x -= cloud.speed;
                        
                        // Reset cloud if it moves off screen
                        if (cloud.x + cloud.radius < 0) {
                            cloud.x = weatherCanvas.width + cloud.radius;
                            cloud.y = Math.random() * weatherCanvas.height * 0.6;
                        }
                    });
                    
                    animationId = requestAnimationFrame(draw);
                }
                
                draw();
            }
            
            // Create rain animation using canvas
            function createRainAnimation(isStorm = false) {
                const drops = [];
                
                for (let i = 0; i < 100; i++) {
                    drops.push({
                        x: Math.random() * weatherCanvas.width,
                        y: Math.random() * weatherCanvas.height,
                        length: Math.random() * 20 + 10,
                        speed: Math.random() * 5 + 5,
                        opacity: Math.random() * 0.5 + 0.5
                    });
                }
                
                function draw() {
                    ctx.clearRect(0, 0, weatherCanvas.width, weatherCanvas.height);
                    
                    drops.forEach(drop => {
                        ctx.beginPath();
                        ctx.moveTo(drop.x, drop.y);
                        ctx.lineTo(drop.x - 1, drop.y + drop.length);
                        ctx.strokeStyle = `rgba(255, 255, 255, ${drop.opacity})`;
                        ctx.lineWidth = 2;
                        ctx.stroke();
                        
                        // Move drop
                        drop.y += drop.speed;
                        
                        // Reset drop if it moves off screen
                        if (drop.y > weatherCanvas.height) {
                            drop.y = -drop.length;
                            drop.x = Math.random() * weatherCanvas.width;
                        }
                    });
                    
                    animationId = requestAnimationFrame(draw);
                }
                
                draw();
                
                // Add lightning for storms
                if (isStorm) {
                    setInterval(() => {
                        if (Math.random() > 0.7) {
                            const x = Math.random() * weatherCanvas.width;
                            
                            ctx.beginPath();
                            ctx.moveTo(x, 0);
                            ctx.lineTo(x, weatherCanvas.height);
                            ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                            
                            setTimeout(() => {
                                ctx.clearRect(0, 0, weatherCanvas.width, weatherCanvas.height);
                            }, 100);
                        }
                    }, 3000);
                }
            }
            
            // Create snow animation using canvas
            function createSnowAnimation() {
                const flakes = [];
                
                for (let i = 0; i < 80; i++) {
                    flakes.push({
                        x: Math.random() * weatherCanvas.width,
                        y: Math.random() * weatherCanvas.height,
                        radius: Math.random() * 3 + 1,
                        speed: Math.random() * 2 + 1,
                        swing: Math.random() * 0.5 + 0.5,
                        swingSpeed: Math.random() * 0.05 + 0.02,
                        angle: 0
                    });
                }
                
                function draw() {
                    ctx.clearRect(0, 0, weatherCanvas.width, weatherCanvas.height);
                    
                    flakes.forEach(flake => {
                        ctx.beginPath();
                        ctx.arc(flake.x, flake.y, flake.radius, 0, Math.PI * 2);
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                        ctx.fill();
                        
                        // Move flake
                        flake.y += flake.speed;
                        flake.angle += flake.swingSpeed;
                        flake.x += Math.sin(flake.angle) * flake.swing;
                        
                        // Reset flake if it moves off screen
                        if (flake.y > weatherCanvas.height) {
                            flake.y = -flake.radius * 2;
                            flake.x = Math.random() * weatherCanvas.width;
                        }
                    });
                    
                    animationId = requestAnimationFrame(draw);
                }
                
                draw();
            }
            
            // Create sun animation using canvas
            function createSunAnimation() {
                const sun = {
                    x: weatherCanvas.width * 0.8,
                    y: weatherCanvas.height * 0.2,
                    radius: 50,
                    pulse: 0,
                    pulseDirection: 1
                };
                
                function draw() {
                    ctx.clearRect(0, 0, weatherCanvas.width, weatherCanvas.height);
                    
                    // Draw sun
                    const gradient = ctx.createRadialGradient(
                        sun.x, sun.y, 0,
                        sun.x, sun.y, sun.radius + sun.pulse
                    );
                    gradient.addColorStop(0, 'rgba(255, 219, 0, 1)');
                    gradient.addColorStop(1, 'rgba(255, 219, 0, 0)');
                    
                    ctx.beginPath();
                    ctx.arc(sun.x, sun.y, sun.radius + sun.pulse, 0, Math.PI * 2);
                    ctx.fillStyle = gradient;
                    ctx.fill();
                    
                    // Update pulse
                    sun.pulse += 0.1 * sun.pulseDirection;
                    if (sun.pulse > 10 || sun.pulse < 0) {
                        sun.pulseDirection *= -1;
                    }
                    
                    animationId = requestAnimationFrame(draw);
                }
                
                draw();
            }
            
            // Create stars animation using canvas
            function createStarsAnimation() {
                const stars = [];
                
                for (let i = 0; i < 100; i++) {
                    stars.push({
                        x: Math.random() * weatherCanvas.width,
                        y: Math.random() * weatherCanvas.height,
                        radius: Math.random() * 1.5 + 0.5,
                        opacity: Math.random() * 0.5 + 0.3,
                        twinkleSpeed: Math.random() * 0.03 + 0.01,
                        twinkleDirection: Math.random() > 0.5 ? 1 : -1
                    });
                }
                
                function draw() {
                    ctx.clearRect(0, 0, weatherCanvas.width, weatherCanvas.height);
                    
                    stars.forEach(star => {
                        ctx.beginPath();
                        ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                        ctx.fill();
                        
                        // Twinkle effect
                        star.opacity += star.twinkleSpeed * star.twinkleDirection;
                        if (star.opacity > 0.8 || star.opacity < 0.3) {
                            star.twinkleDirection *= -1;
                        }
                    });
                    
                    animationId = requestAnimationFrame(draw);
                }
                
                draw();
            }
            
            // Convert temperature based on current unit
            function convertTemperature(temp) {
                if (isCelsius) {
                    return temp;
                } else {
                    return Math.round((temp * 9/5) + 32);
                }
            }
            
            // Update temperature display based on current unit
            function updateTemperatureDisplay() {
                if (currentWeatherData) {
                    const temp = convertTemperature(currentWeatherData.main.temp);
                    temperatureElement.textContent = Math.round(temp);
                    
                    if (isCelsius) {
                        temperatureElement.classList.remove('fahrenheit');
                    } else {
                        temperatureElement.classList.add('fahrenheit');
                    }
                    
                    // Update forecast temperatures
                    updateForecastTemperatures();
                }
            }
            
            // Update forecast temperatures
            function updateForecastTemperatures() {
                // Update hourly forecast temperatures
                const hourlyItems = document.querySelectorAll('.hourly-temp');
                if (currentWeatherData.hourlyForecast) {
                    hourlyItems.forEach((item, index) => {
                        if (index < currentWeatherData.hourlyForecast.length) {
                            const forecastTemp = convertTemperature(currentWeatherData.hourlyForecast[index].temp);
                            item.textContent = Math.round(forecastTemp) + '°';
                        }
                    });
                }
                
                // Update daily forecast temperatures
                const dailyItems = document.querySelectorAll('.daily-temp');
                if (currentWeatherData.dailyForecast) {
                    dailyItems.forEach((item, index) => {
                        if (index < currentWeatherData.dailyForecast.length) {
                            const forecastTemp = convertTemperature(currentWeatherData.dailyForecast[index].temp);
                            item.textContent = Math.round(forecastTemp) + '°';
                        }
                    });
                }
            }
            
            // Get user's location
            function getLocation() {
                if (navigator.geolocation) {
                    showLoading();
                    
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            fetchWeatherByCoords(lat, lon);
                        },
                        err => {
                            hideLoading();
                            showError('Location access denied. Please search for a city manually.');
                        }
                    );
                } else {
                    showError('Geolocation is not supported by your browser.');
                }
            }
            
            // Show loading state
            function showLoading() {
                loading.style.display = 'block';
                error.style.display = 'none';
                
                // Show skeleton loading for forecast
                showSkeletonLoading();
            }
            
            // Hide loading state
            function hideLoading() {
                loading.style.display = 'none';
                
                // Hide skeleton loading
                hideSkeletonLoading();
            }
            
            // Show skeleton loading
            function showSkeletonLoading() {
                // Skeleton for hourly forecast
                hourlyForecast.innerHTML = '';
                for (let i = 0; i < 8; i++) {
                    const hourlyItem = document.createElement('div');
                    hourlyItem.className = 'hourly-item skeleton';
                    hourlyItem.innerHTML = `
                        <div class="hourly-time skeleton skeleton-text"></div>
                        <div class="hourly-icon skeleton skeleton-circle" style="margin: 5px auto;"></div>
                        <div class="hourly-temp skeleton skeleton-text"></div>
                    `;
                    hourlyForecast.appendChild(hourlyItem);
                }
                
                // Skeleton for daily forecast
                dailyForecast.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const dailyItem = document.createElement('div');
                    dailyItem.className = 'daily-item skeleton';
                    dailyItem.innerHTML = `
                        <div class="daily-day skeleton skeleton-text"></div>
                        <div class="daily-icon skeleton skeleton-circle" style="margin: 5px auto;"></div>
                        <div class="daily-temp skeleton skeleton-text"></div>
                    `;
                    dailyForecast.appendChild(dailyItem);
                }
            }
            
            // Hide skeleton loading
            function hideSkeletonLoading() {
                const skeletonElements = document.querySelectorAll('.skeleton');
                skeletonElements.forEach(el => {
                    el.classList.remove('skeleton');
                });
            }
            
            // Show error message
            function showError(message) {
                error.innerHTML = `<p>${message}</p>`;
                error.style.display = 'block';
                
                // Hide error after 5 seconds
                setTimeout(() => {
                    error.style.display = 'none';
                }, 5000);
            }
            
            // Fetch weather by city name
            function fetchWeather(city) {
                showLoading();
                currentCity = city;
                
                // Fetch current weather
                fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&appid=${apiKey}`)
                    .then(response => {
                        if (!response.ok) {
                            if (response.status === 401) {
                                throw new Error('Invalid API key. Please check your API configuration.');
                            } else if (response.status === 404) {
                                throw new Error('City not found. Please try again.');
                            } else {
                                throw new Error('Network error. Please try again.');
                            }
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Fetch forecast data
                        return Promise.all([
                            data,
                            fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${city}&units=metric&appid=${apiKey}`)
                                .then(response => response.json())
                        ]);
                    })
                    .then(([currentData, forecastData]) => {
                        hideLoading();
                        updateWeatherUI(currentData, forecastData);
                    })
                    .catch(err => {
                        hideLoading();
                        showError(err.message);
                    });
            }
            
            // Fetch weather by coordinates
            function fetchWeatherByCoords(lat, lon) {
                showLoading();
                
                // Fetch current weather
                fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`)
                    .then(response => response.json())
                    .then(data => {
                        // Fetch forecast data
                        return Promise.all([
                            data,
                            fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`)
                                .then(response => response.json())
                        ]);
                    })
                    .then(([currentData, forecastData]) => {
                        hideLoading();
                        currentCity = currentData.name;
                        searchInput.value = currentCity;
                        updateWeatherUI(currentData, forecastData);
                    })
                    .catch(err => {
                        hideLoading();
                        showError('Failed to fetch weather data. Please try again.');
                    });
            }
            
            // Update UI with weather data
            function updateWeatherUI(currentData, forecastData) {
                // Update city name
                document.getElementById('city-name').textContent = currentData.name;
                
                // Update temperature
                currentWeatherData = currentData;
                updateTemperatureDisplay();
                
                // Update weather description and icon
                const weatherDescription = currentData.weather[0].description;
                const weatherIconCode = currentData.weather[0].icon;
                document.getElementById('weather-description').textContent = weatherDescription.charAt(0).toUpperCase() + weatherDescription.slice(1);
                document.getElementById('weather-icon').className = `fas ${weatherIcons[weatherIconCode] || 'fa-cloud'} weather-icon`;
                
                // Update background based on weather condition
                updateWeatherBackground(weatherDescription, weatherIconCode);
                
                // Update details
                document.getElementById('wind-speed').textContent = Math.round(currentData.wind.speed * 3.6) + ' km/h';
                document.getElementById('humidity').textContent = currentData.main.humidity + '%';
                document.getElementById('pressure').textContent = currentData.main.pressure + ' hPa';
                
                // Handle visibility (might be missing in some API responses)
                if (currentData.visibility) {
                    document.getElementById('visibility').textContent = (currentData.visibility / 1000).toFixed(1) + ' km';
                } else {
                    document.getElementById('visibility').textContent = 'N/A';
                }
                
                // Update forecast
                updateForecastUI(forecastData);
                
                // Check for weather alerts
                checkWeatherAlerts(currentData);
            }
            
            // Update forecast UI
            function updateForecastUI(forecastData) {
                // Clear previous forecast
                hourlyForecast.innerHTML = '';
                dailyForecast.innerHTML = '';
                
                // Check if we have forecast data
                if (!forecastData || !forecastData.list || forecastData.list.length === 0) {
                    hourlyForecast.innerHTML = '<div class="hourly-item">No forecast data</div>';
                    dailyForecast.innerHTML = '<div class="daily-item">No forecast data</div>';
                    return;
                }
                
                // Get hourly forecast (next 24 hours, 3-hour intervals)
                const hourlyData = forecastData.list.slice(0, 8);
                
                // Store forecast data
                currentWeatherData.hourlyForecast = hourlyData.map(item => ({
                    temp: item.main.temp,
                    icon: item.weather[0].icon,
                    time: new Date(item.dt * 1000)
                }));
                
                // Create hourly forecast items
                hourlyData.forEach(item => {
                    const date = new Date(item.dt * 1000);
                    const hours = date.getHours();
                    const time = hours === 0 ? '12AM' : hours < 12 ? `${hours}AM` : hours === 12 ? '12PM' : `${hours - 12}PM`;
                    const iconCode = item.weather[0].icon;
                    const temp = convertTemperature(item.main.temp);
                    
                    const hourlyItem = document.createElement('div');
                    hourlyItem.className = 'hourly-item';
                    hourlyItem.innerHTML = `
                        <div class="hourly-time">${time}</div>
                        <i class="fas ${weatherIcons[iconCode] || 'fa-cloud'} hourly-icon"></i>
                        <div class="hourly-temp">${Math.round(temp)}°</div>
                    `;
                    
                    hourlyForecast.appendChild(hourlyItem);
                });
                
                // Get daily forecast (next 5 days)
                const dailyData = [];
                const processedDays = new Set();
                
                for (const item of forecastData.list) {
                    const date = new Date(item.dt * 1000);
                    const day = date.toDateString();
                    
                    // Only take one reading per day (around noon)
                    if (!processedDays.has(day) && date.getHours() >= 10 && date.getHours() <= 14) {
                        dailyData.push(item);
                        processedDays.add(day);
                        
                        if (dailyData.length >= 5) break;
                    }
                }
                
                // Store forecast data
                currentWeatherData.dailyForecast = dailyData.map(item => ({
                    temp: item.main.temp,
                    icon: item.weather[0].icon,
                    date: new Date(item.dt * 1000)
                }));
                
                // Create daily forecast items
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dailyData.forEach(item => {
                    const date = new Date(item.dt * 1000);
                    const day = days[date.getDay()];
                    const iconCode = item.weather[0].icon;
                    const temp = convertTemperature(item.main.temp);
                    
                    const dailyItem = document.createElement('div');
                    dailyItem.className = 'daily-item';
                    dailyItem.innerHTML = `
                        <div class="daily-day">${day}</div>
                        <i class="fas ${weatherIcons[iconCode] || 'fa-cloud'} daily-icon"></i>
                        <div class="daily-temp">${Math.round(temp)}°</div>
                    `;
                    
                    dailyForecast.appendChild(dailyItem);
                });
            }
            
            // Check for weather alerts
            function checkWeatherAlerts(weatherData) {
                // In a real implementation, you would check weatherData.alerts or similar
                // For demo purposes, we'll show an alert for thunderstorms
                if (weatherData.weather[0].main === 'Thunderstorm') {
                    document.getElementById('alert-message').textContent = 'Thunderstorm expected. Take precautions! ⚡';
                    weatherAlert.style.display = 'block';
                } else {
                    weatherAlert.style.display = 'none';
                }
            }
            
            // Toggle theme
            function toggleTheme() {
                isDarkMode = !isDarkMode;
                document.body.classList.toggle('dark-mode', isDarkMode);
                
                themeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                themeToggle.setAttribute('aria-label', isDarkMode ? 'Switch to light mode' : 'Switch to dark mode');
            }
            
            // Toggle forecast view
            function toggleForecastView() {
                isShowingDailyForecast = !isShowingDailyForecast;
                
                if (isShowingDailyForecast) {
                    hourlyForecast.style.display = 'none';
                    dailyForecast.style.display = 'grid';
                    forecastToggle.innerHTML = 'Hourly forecast <i class="fas fa-chevron-up"></i>';
                } else {
                    hourlyForecast.style.display = 'flex';
                    dailyForecast.style.display = 'none';
                    forecastToggle.innerHTML = '5-day forecast <i class="fas fa-chevron-down"></i>';
                }
            }
            
            // Event listeners
            searchBtn.addEventListener('click', () => {
                const city = searchInput.value.trim();
                if (city) {
                    fetchWeather(city);
                }
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const city = searchInput.value.trim();
                    if (city) {
                        fetchWeather(city);
                    }
                }
            });
            
            unitToggle.addEventListener('click', function() {
                isCelsius = !isCelsius;
                unitToggle.textContent = isCelsius ? '°C / °F' : '°F / °C';
                updateTemperatureDisplay();
            });
            
            locationBtn.addEventListener('click', getLocation);
            
            refreshBtn.addEventListener('click', () => {
                if (currentCity) {
                    fetchWeather(currentCity);
                }
            });
            
            themeToggle.addEventListener('click', toggleTheme);
            
            forecastToggle.addEventListener('click', toggleForecastView);
            
            // Initialize
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            updateDate();
            
            // Try to get user's location on first load
            getLocation();
        });
    </script>
</body>
</html>